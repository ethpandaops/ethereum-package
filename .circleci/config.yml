version: 2.1

orbs:
  kurtosis-docs-checker: kurtosis-tech/docs-checker@0.2.3

executors:
  ubuntu_vm:
    machine:
      image: ubuntu-2004:202201-02

parameters:
  should-enable-check-latest-version-workflow:
    type: boolean
    default: false
  should-enable-build-workflow:
    type: boolean
    default: true

setup_kurtosis: &setup_kurtosis
  - run: |
      echo "deb [trusted=yes] https://apt.fury.io/kurtosis-tech/ /" | sudo tee /etc/apt/sources.list.d/kurtosis.list
      sudo apt update
      sudo apt install kurtosis-cli
      kurtosis config init dont-send-metrics
      kurtosis engine restart

jobs:
  run_starlark:
    executor: ubuntu_vm
    steps:
      - <<: *setup_kurtosis
      - checkout
      - run: kurtosis run ${PWD}

  check_latest_version:
    executor: ubuntu_vm
    resource_class: xlarge
    steps:
      - <<: *setup_kurtosis
      - checkout
      - run: kurtosis run --dry-run ${PWD}

workflows:
  version: 2
  nightly_tests_workflow:
    jobs:
      - run_starlark

      - if: << parameters.should-enable-check-latest-version-workflow >>
        job: check_latest_version

      - run:
          name: Generate Nightly Test Jobs
          command: |
            for file in ./.circleci/tests/*.json; do
              test_name=$(basename "$file" .json)
              echo "Creating job for $test_name"
              circleci config process .circleci/config-template.yml \
                -o .circleci/config-temp.yml \
                -e TEST_NAME=$test_name TEST_FILE=$file
              circleci config process .circleci/config-temp.yml >> .circleci/config.yml
            done
